# MQTT controller for Beok BOT-313 thermostat
### Замена WiFi модуля Broadlink в термостате Beok BOT-313 WiFi на ESP8266

   WiFi термостаты Beok вполне заслуженно ценятся "умнодомостроителями" и давно зарекомендовали себя как 
функциональные, отработанные и надежные устройства. Они имеют неплохой внешний вид и несколько дизайнов на любой вкус, 
удобный интерфейс и гибкую систему работы по расписанию в автоматическом режиме.

   Штатное приложение умеет управлять термостатами в локальной сети (без выхода наружу) либо через пропиретарные облачные скревера.
Но, к сожалению, к самому приложению [Beok Home](https://play.google.com/store/apps/details?id=com.beok.heat) как раз есть претензии.

   Кроме того рано или поздно возникает задача интегрировать термостат в локальную систему управления умным домом 
типа MajorDoMo или HomeAssistant. Поскольку WiFi часть этих термостатов построена на базе готового модуля Broadlink - 
задача решается с помощью установки соответствующей интеграции 
(например [модуля Broadlink для MajorDoMo](https://connect.smartliving.ru/addons/category1/32.html)). Но использование такого 
подхода обозначает необходимость периодического опроса всех термостатов, что с одной стороны создает дополнительную нагрузку 
на сервер, а с другой - приводит к сушественным задержкам при отрабатывании сценариев "по событию", особенно если часть 
термостатов находится в офлайне.

    Поэтому хотелось бы упростить интеграцию в локальные системы умного дома, обеспечив прямой доступ к термостату 
по протоколу MQTT. Это позволит не только отказаться от использования интеграций Broadlink и разгрузить сервер умного дома,
но и реализовать сценарии управления на уровне протокола MQTT, независимые от сервера.

    Как было отмечено выше, удаленное управление термостаом реализовано на базе пропиретарного WiFi модуля 
Broadlink BL3335-P (описание модуля находится в [Docs](https://github.com/mosave/Beok2MQTT/tree/main/Docs)), который 
взаимодействует с контроллером термостатоа через последовательный UART интерфейс (9600/None/1). К сожалению,
BL335-P имеет закрытую структуру и пропиретарный toolchain. Анализ данных, передаваемых по UART показал что 
при ээтом используется тот же самый протокол, что реализован в модуле Broadlink для MajorDoMo. 
Поэтому можно достаточно просто заменить BL335 на MQTT клиент на базе WiFi модуля на ESP8266, который в свою 
очередь будет взаимодействовать с MCU термостата. Дополнительным бонусом такого подхода является возможность
подключения дополнительных сенсоров и исполнительных устройств, например датчика влажности, освещенности 
или движения.

 
### Использованное железо

  * Совместимые термостаты: 
    * [Beok BOT-313 WiFi с любым суффиксом](http://www.beok-controls.com/pro_view.asp?id=66) ([проверено](https://aliexpress.ru/item/4000202232813.html))
    * [Beok TGP-351 WiFi с любым суффиксом](http://www.beok-controls.com/pro_view.asp?id=82) ([проверено](https://aliexpress.ru/item/4000695450163.html))
    * Любой термостат, совместимый с модулем [Broadlink для MajorDoMo в режиме "PHP only"](https://connect.smartliving.ru/addons/category1/32.html). 
      Контроллер Broadlink, установленный в термостате по умолчанию реализует "прозрачную" передачу данных от MCU термостата. Поэтому протокол, реализованный в модуле MajorDoMo 
      полностью совпадает с протоколом, реализованным в контроллере на базе ESP8266.
    * С большой вероятностью [любой WiFi термостат Beok](http://www.beok-controls.com/product.asp). Но здесь, понятно, никаких гарантий дать нельзя.
  * [ESP-01S или любой другой ESP8266 модуль (от $10/10шт)]

### Прошивка WiFi контроллера

    В каталоге [BOT313Firmware](https://github.com/mosave/Beok2MQTT/tree/main/BOT313Firmware) находятся исходники 
вполне работсобной прошивки, которая тем не менее все находится в режиме разработки.
прошивки WiFi контроллера, собранной на основе [IoT Framework](https://github.com/mosave/AELib). 
 Кроме того

### Список MQTT топиков и соответствующих им команд

Поскольку прошивка WiFi модуля термостата собрана на основе готового [фреймворка](https://github.com/mosave/AELib), 
она публикует все "стандартные" топики и поддерживает все функции, реализованные в фреймворке.

 * **Power**: Состояние термостата. 1 - включен, 0 - выключен
   * **SetPower**: Включить (1) или выключить (0)
 * **Heating**: Состояние реле управления обогревателем. 1 - обогреватель включен, 0 - выключен
 * **Locked**: Блокировка кнопок: 1 - включена, 0 - выключена
   * **SetLocked**: Включить (1) или выключить (0) блокировку кнопок
 * **TargetSetManually**: В режиме автоматического управления целевая температура была изменена кнопками (1/0)
 * **RoomTemp**: Текущая температура воздуха (точность 0.5°)
 * **FloorTemp**: Текущая температура внешнего датчика, если поддерживается и установлен
 * **FloorTempMax**: Максимальная температура разаргрева пола (при наличии датчика температуры пола)
 * **Sensor**: Конфигурация датчиков температуры (зависит от модели термостата, см. документацию)
   * **SetSensor**: Выбор конфигурации датчиков температуры

 * **TargetTemp**: Текущая целевая температура
 * **TargetTempMax**..**TargetTempMin**: Диапазон допустимых значений целевой температуры
   * **SetTargetTemp**: Установка целевой температуры
 * **AutoMode**: Включен автоматический (1) либо ручной (0) режим управления
   * **SetAutoMode**: Выбор автоматического (1) либо ручного (0) режима управления

 * **LoopMode**: Текущий способ выбора первого или второго расписания в автоматическом режиме: 0: 5+2 дня, 1: 6+1 день, 2: 7 дней (см. документацию к термостату)
   * **SetLoopMode**: Установка способа выбора расписания, 0, 1 или 2 

 * **Schedule**, **Schedule2**: Первое и второе расписания в режиме автоматической работы. Указывает 
   с какого времени требуется установить заданную температуру. В первом расписании определяется 5 временных интервалов,
   во втором расписании только 2 (см. документацию к термостату)
   * **SetSchedule**, **SetSchedule2**: Установка расписаний работы. Формат соответствует значению топиков **Schedule** и **Schedule2**

 * **Hysteresis**: Точность, с которой будет выдерживаться заданная температура
 * **AdjTemp**: Поправка к значению датчика температуры
 * **AntiFroze**: Режим защиты от замерзания включен (1) либо выключен (0)
 * **PowerOnMemory**: Восстанавливать (1) или не восстанавливать (0) состояние термостата после пропадения питания
 * **Time**, **Weekday**: Время (ЧЧ:ММ) и текущий день недели (1..7)
 * **SetTime**, **SetWeekday**: Задание текущего веремени и дня недели


### Фотографии


[Несколько фотографий лежат здесь](https://github.com/mosave/Beok2MQTT/tree/main/Photos)

